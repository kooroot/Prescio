# Prescio Betting Phase Design

> **베팅 타이밍과 게임 페이즈의 정밀한 동기화**

---

## 📋 Overview

Prescio의 베팅 시스템은 게임의 정보 공개 흐름과 동기화되어야 합니다. 이 문서는 각 게임 페이즈에서 베팅 상태가 어떻게 변화하는지 정의합니다.

---

## 🎮 게임 페이즈 정의

| Phase | 한글 | 기본 시간 | 설명 |
|-------|------|----------|------|
| `LOBBY` | 대기실 | - | 게임 생성, 에이전트 배치 |
| `NIGHT` | 밤 | 15초 | 임포스터가 타겟 선정 및 킬 |
| `REPORT` | 신고 | 10초 | 시체 발견 알림 |
| `DISCUSSION` | 토론 | 60초 | 에이전트들 대화 및 추리 |
| `VOTE` | 투표 | 30초 | 에이전트들 투표 |
| `RESULT` | 결과 | 5초 | 추방 결과 발표 |
| `GAME_OVER` | 종료 | - | 최종 승자 결정 |

---

## 🎰 베팅 상태 정의

| State | 설명 | 유저 액션 |
|-------|------|----------|
| `INACTIVE` | 마켓 미생성 | 베팅 불가 |
| `PAUSED` | 마켓 존재, 베팅 일시정지 | 베팅 불가, 오즈 조회 가능 |
| `OPEN` | 베팅 활성화 | 베팅 가능, 오즈 실시간 변동 |
| `LOCKED` | 베팅 잠금 | 베팅 불가, 기존 베팅 유지 |
| `RESOLVED` | 정산 완료 | Claim 가능 |

---

## 🔄 전체 게임 플로우

### 라운드 1 (첫 번째 사이클)

```
┌────────────────────────────────────────────────────────────────────┐
│                           ROUND 1                                   │
├──────────┬─────────────┬───────────────────────────────────────────┤
│  Phase   │ Betting     │ 상세 설명                                   │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  LOBBY   │ INACTIVE    │ • 에이전트 5~7명 배치                        │
│          │             │ • 역할 미배정                               │
│          │             │ • 마켓 아직 생성 안됨                         │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  START   │ INACTIVE    │ • 게임 시작 버튼 클릭                        │
│  (전환)   │ → PAUSED    │ • 역할 배정 (임포스터/크루)                   │
│          │             │ • 🎰 마켓 생성 (createMarket)               │
│          │             │ • 아직 베팅 불가 (정보 없음)                   │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  NIGHT   │ PAUSED      │ • 임포스터 AI가 타겟 선정                     │
│  (15초)  │             │ • 킬 실행 (유저는 모름)                       │
│          │             │ • ❌ 베팅 불가                               │
│          │             │ • 이유: 유저에게 정보 없음                    │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  REPORT  │ PAUSED      │ • "Agent-Delta 사망!" 알림                  │
│  (10초)  │ → OPEN      │ • 🟢 베팅 시작 (CCA Phase 1)                │
│          │             │ • 첫 번째 정보 공개                          │
│          │             │ • 유저: 사망자 제외하고 추측 시작              │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│DISCUSSION│ OPEN        │ • 에이전트들 토론                            │
│  (60초)  │             │ • 🟡 베팅 활성 (가격 상승 중)                 │
│          │             │ • 정보 계속 공개 (대화 로그)                   │
│          │             │ • CCA 배치 청산 진행                         │
│          │ → LOCKED    │ • 토론 종료 시 🔒 베팅 마감                   │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  VOTE    │ LOCKED      │ • 에이전트들 투표                            │
│  (30초)  │             │ • ❌ 베팅 불가                               │
│          │             │ • 투표 결과로 추가 정보 노출 방지              │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  RESULT  │ LOCKED      │ • 추방 결과 발표                             │
│  (5초)   │             │ • 임포스터 추방? → GAME_OVER                 │
│          │             │ • 크루 추방? → NIGHT (Round 2)               │
│          │             │                                            │
└──────────┴─────────────┴───────────────────────────────────────────┘
```

### 라운드 2+ (반복 사이클)

```
┌────────────────────────────────────────────────────────────────────┐
│                           ROUND N (N ≥ 2)                          │
├──────────┬─────────────┬───────────────────────────────────────────┤
│  Phase   │ Betting     │ 상세 설명                                   │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  NIGHT   │ PAUSED      │ • 임포스터 추가 킬                           │
│  (15초)  │             │ • 생존자 수 감소                             │
│          │             │ • ❌ 베팅 불가                               │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  REPORT  │ PAUSED      │ • 새로운 사망자 발표                         │
│  (10초)  │ → OPEN      │ • 🟢 베팅 재개 (CCA Phase N)                │
│          │             │ • 📈 가격: P_base × (1+i)^N                 │
│          │             │ • 라운드 높을수록 비쌈 (정보 프리미엄)         │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│DISCUSSION│ OPEN        │ • 더 많은 정보 누적                          │
│  (60초)  │             │ • 에이전트 수 감소 → 추리 용이                │
│          │ → LOCKED    │ • 토론 종료 시 🔒 베팅 마감                   │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  VOTE    │ LOCKED      │ • 투표 진행                                 │
│  (30초)  │             │ • ❌ 베팅 불가                               │
│          │             │                                            │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│  RESULT  │ LOCKED      │ • 게임 종료 조건 체크                        │
│  (5초)   │             │ • 임포스터 추방 → GAME_OVER                  │
│          │             │ • 크루 2명 이하 → GAME_OVER (임포스터 승)     │
│          │             │ • 그 외 → NIGHT (Round N+1)                 │
│          │             │                                            │
└──────────┴─────────────┴───────────────────────────────────────────┘
```

### 게임 종료

```
┌────────────────────────────────────────────────────────────────────┐
│                           GAME_OVER                                │
├──────────┬─────────────┬───────────────────────────────────────────┤
│  Phase   │ Betting     │ 상세 설명                                   │
├──────────┼─────────────┼───────────────────────────────────────────┤
│          │             │                                            │
│ GAME_OVER│ LOCKED      │ • 최종 승자 결정                            │
│          │ → RESOLVED  │ • 🏆 마켓 정산 (resolve)                    │
│          │             │ • 임포스터 인덱스 공개                       │
│          │             │ • 정답자: claim() 호출 가능                  │
│          │             │ • 오답자: 베팅 손실                          │
│          │             │                                            │
└──────────┴─────────────┴───────────────────────────────────────────┘
```

---

## 📊 상태 전이 다이어그램

```
                    ┌──────────────────────────────────────┐
                    │                                      │
                    ▼                                      │
┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐      │
│INACTIVE│───▶│ PAUSED │───▶│  OPEN  │───▶│ LOCKED │──────┤
└────────┘    └────────┘    └────────┘    └────────┘      │
   게임          마켓          베팅          베팅           │
   시작전        생성          활성          잠금           │
                  │             │             │            │
                  │             │             │            │
                  │◀────────────┘             │            │
                  │   NIGHT 진입              │            │
                  │   (다음 라운드)            │            │
                  │                           │            │
                  │                           ▼            │
                  │                      ┌────────┐        │
                  │                      │RESOLVED│        │
                  │                      └────────┘        │
                  │                        정산            │
                  │                        완료            │
                  │                                        │
                  └────────────────────────────────────────┘
                              게임 종료 시
```

---

## 🎯 베팅 타이밍 근거

### 왜 NIGHT에 베팅을 막는가?

| 문제 | 설명 |
|------|------|
| **정보 비대칭** | NIGHT 시작 시점에 유저는 아무 정보가 없음 |
| **찍은 애가 죽음** | 베팅한 에이전트가 바로 킬당할 수 있음 |
| **불공정** | 랜덤 베팅 = 도박, 전략적 베팅 불가 |

### 왜 REPORT에서 베팅을 시작하는가?

| 이점 | 설명 |
|------|------|
| **첫 정보 공개** | 사망자 신원 공개 → 용의자 풀 축소 |
| **전략적 판단** | 누가 죽었는지 보고 추리 시작 가능 |
| **공정한 출발** | 모든 유저가 동일 정보로 시작 |

### 왜 DISCUSSION에서 베팅을 종료하는가?

| 이점 | 설명 |
|------|------|
| **투표 전 마감** | 투표 패턴으로 임포스터 유추 방지 |
| **토론 활용** | 에이전트 대화 분석 시간 제공 |
| **CCA 청산** | 토론 종료 시점에 최종 가격 확정 |

### 왜 VOTE에서 베팅을 막는가?

| 문제 | 설명 |
|------|------|
| **투표 정보 노출** | 투표 현황 보고 베팅하면 불공정 |
| **후발 유리** | 투표 집계 보고 "거의 확실"한 베팅 가능 |
| **게임 무결성** | 결과 직전 베팅 = 결과 조작과 유사 |

---

## ⏱️ 타임라인 예시: 7인 3라운드 게임

```
시간  0:00                                           총 ~6분 30초
  │
  │  LOBBY ─────────────────────────────────────────────────────────
  │  • 에이전트 배치
  │
  ▼  0:00 게임 시작 ════════════════════════════════════════════════
  │
  │  NIGHT (R1) ─────────────────────── 15초 ─────────────────────
  │  • 베팅: PAUSED
  │  • Agent-Delta 킬됨 (아직 비밀)
  │
  ▼  0:15 ══════════════════════════════════════════════════════════
  │
  │  REPORT (R1) ─────────────────────── 10초 ────────────────────
  │  • 🟢 베팅 OPEN (CCA Phase 1)
  │  • "Agent-Delta 사망!"
  │
  ▼  0:25 ══════════════════════════════════════════════════════════
  │
  │  DISCUSSION (R1) ─────────────────── 60초 ────────────────────
  │  • 베팅 OPEN (가격 상승 중)
  │  • 에이전트들 토론
  │  • 0:85에 🔒 베팅 LOCKED
  │
  ▼  1:25 ══════════════════════════════════════════════════════════
  │
  │  VOTE (R1) ────────────────────────── 30초 ───────────────────
  │  • 베팅: LOCKED
  │  • Agent-Charlie 추방됨 (크루)
  │
  ▼  1:55 ══════════════════════════════════════════════════════════
  │
  │  RESULT (R1) ───────────────────────── 5초 ───────────────────
  │  • 크루 추방 → 게임 계속
  │
  ▼  2:00 ══════════════════════════════════════════════════════════
  │
  │  NIGHT (R2) ─────────────────────── 15초 ─────────────────────
  │  • 베팅: PAUSED
  │  • Agent-Echo 킬됨
  │
  ▼  2:15 ══════════════════════════════════════════════════════════
  │
  │  REPORT (R2) ─────────────────────── 10초 ────────────────────
  │  • 🟢 베팅 OPEN (CCA Phase 2)
  │  • 📈 가격: P × 1.5 (정보 프리미엄)
  │
  ▼  2:25 ══════════════════════════════════════════════════════════
  │
  │  DISCUSSION (R2) ─────────────────── 60초 ────────────────────
  │  • 베팅 OPEN
  │  • 3:25에 🔒 베팅 LOCKED
  │
  ▼  3:25 ══════════════════════════════════════════════════════════
  │
  │  VOTE (R2) ────────────────────────── 30초 ───────────────────
  │  • Agent-Bravo 추방됨 (임포스터!)
  │
  ▼  3:55 ══════════════════════════════════════════════════════════
  │
  │  RESULT (R2) ───────────────────────── 5초 ───────────────────
  │  • 🏆 임포스터 추방 → 크루 승리!
  │
  ▼  4:00 ══════════════════════════════════════════════════════════
  │
  │  GAME_OVER ──────────────────────────────────────────────────
  │  • 마켓 RESOLVED
  │  • Agent-Bravo 베팅자 → claim() 가능
  │
  ▼  END
```

---

## 🔧 구현 체크리스트

### V1 (현재 - 단순화)

- [x] LOBBY: 마켓 없음
- [ ] NIGHT: 베팅 PAUSED (현재는 OPEN → 변경 필요)
- [ ] REPORT: 베팅 OPEN 전환
- [ ] DISCUSSION 종료: 베팅 LOCKED (현재는 VOTE 시작 시 → 변경 필요)
- [x] VOTE: 베팅 LOCKED
- [x] GAME_OVER: 마켓 RESOLVED

### V2 (CCA 추가)

- [ ] 라운드별 CCA Phase 분리
- [ ] 가격 프리미엄: `P_base × (1+i)^round`
- [ ] 블록 단위 배치 청산
- [ ] 사망 에이전트 민팅 중단 + 보험 처리

---

## 📚 Related Documents

- [VISION.md](./VISION.md) - V2 전체 기술 비전
- [ROADMAP.md](./ROADMAP.md) - 개발 로드맵
- [TOKENOMICS.md](./TOKENOMICS.md) - 토큰 이코노믹스

---

*이 문서는 Prescio의 베팅 타이밍 설계를 정의합니다. 구현 시 이 스펙을 기준으로 합니다.*
